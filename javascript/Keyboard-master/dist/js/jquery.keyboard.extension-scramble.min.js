!function(a){"use strict";a.keyboard=a.keyboard||{},a.fn.addScramble=function(b){var c={targetKeys:/[a-z\d]/i,byRow:!0,byKeySet:!1,randomizeOnce:!0};return this.each(function(){var d,e=a(this).data("keyboard"),f=e.options;e&&!e.scramble_options&&(d=e.scramble_options=a.extend({},c,b),e.scramble_setup=function(b){var c,f,g,h,i,j,k,l,m,n,o;if(c=b.find("."+a.keyboard.css.keySet),b.length){for(d.byKeySet&&(c=c.eq(0)),f=0;f<c.length;f++)if(g=c.eq(f),k=0,o=[],m=[],l=[],n=[],g.children("button, span, br").each(function(){"BR"===this.tagName?d.byRow?(o.push(this),m.push(!1),n[k]=o,l[k]=m,o=[],m=[],k++):(n[k]=this,l[k]=!1,k++):(j=a(this).attr("data-value")||"",j=1===j.length&&d.targetKeys.test(j)?j:!1,d.byRow?(o.push(this),m.push(j)):(n[k]=this,l[k]=j,k++))}),g.find("."+a.keyboard.css.endRow).remove(),d.byRow)for(i=0;i<n.length;i++)for(o=e.shuffle(n[i],l[i]),h=0;h<o.length;h++)g.append(o[h]);else for(o=e.shuffle(n,l),h=0;h<o.length;h++)g.append(o[h]);return d.byKeySet&&(b=e.realign(b)),b}},e.shuffle=function(a,b){for(var c,d,e=a.length;e>0;)d=Math.floor(Math.random()*e),b[e-1]===!1&&e--,b[e-1]!==!1&&b[d]!==!1&&(e--,c=a[e],a[e]=a[d],a[d]=c);return a},e.realign=function(b){var c,d,e,f=b.find("."+a.keyboard.css.keySet),g=f.eq(0);return f=f.filter(":gt(0)"),g.children().each(function(b,g){d="BR"===g.tagName,e=a(g).attr("data-pos"),f.each(function(b,f){c=d?"br:first":'button[data-pos="'+e+'"]',a(f).find(c).appendTo(f)})}),b},f.create=function(){var b=f.layout;a.keyboard.builtLayouts[b]={mappedKeys:{},acceptedKeys:[],$keyboard:null},"undefined"==typeof a.keyboard.builtLayouts[e.orig_layout]&&(e.layout=f.layout=e.orig_layout,e.buildKeyboard(),e.layout=f.layout=b),a.keyboard.builtLayouts[b]=a.extend(!0,{},a.keyboard.builtLayouts[e.orig_layout]),d.randomizeOnce&&(a.keyboard.builtLayouts[b].$keyboard=e.scramble_setup(a.keyboard.builtLayouts[e.orig_layout].$keyboard.clone())),e.$keyboard=a.keyboard.builtLayouts[b].$keyboard,d.randomizeOnce||e.$el.bind(a.keyboard.events.kbBeforeVisible,function(a,b){b.$keyboard=b.scramble_setup(b.$keyboard)})},/^scrambled/.test(e.options.layout)||(e.orig_layout=e.options.layout,e.options.layout="scrambled"+Math.round(1e4*Math.random())),f.alwaysOpen&&e.$keyboard.length&&setTimeout(function(){e.$keyboard=e.scramble_setup(e.$keyboard)},0))})}}(jQuery);